# -*- mode: ruby -*-
# # vi: set ft=ruby :

Vagrant.configure(2) do |config|
  config.vm.box = 'ubuntu/trusty64'

  config.vm.network 'forwarded_port', guest: 80, host: 8080
  config.vm.network 'private_network', ip: '192.168.33.10'
  config.vm.synced_folder '../', '/www'

  config.vm.provider 'virtualbox' do |vb|
    vb.memory = '1024'
  end

  config.vm.provision 'file', source: 'env.sh', destination: '~/paramsendotcom_env.sh'

  config.vm.provision 'shell', keep_color: true, name: 'shell:provision',  inline: <<-SHELL
    echo "Provisioner/shell:provision"

    apt-get update -qq

    if [ ! -e /usr/local/bin/docker-compose ]; then
      curl -L https://github.com/docker/compose/releases/download/1.7.0-rc1/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
      chmod +x /usr/local/bin/docker-compose
    fi

    if [ ! -e /usr/bin/node ]; then
      curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -
      sudo apt-get install -y nodejs
    fi

    ln -s /opt/VBoxGuestAdditions-*/lib/VBoxGuestAdditions /usr/lib/VBoxGuestAdditions || : >2 /dev/null #ignore errs if already exists

    if [ ! -e /etc/profile.d/paramsendotcom_env.sh ]; then
      cp /home/vagrant/paramsendotcom_env.sh /etc/profile.d/paramsendotcom_env.sh
    fi
  SHELL

  config.vm.provision 'shell', keep_color: true, privileged: false, name: 'shell:setup ~> as vagrant', inline: <<-SHELL
    echo "Provisioner/shell:setup"
  SHELL

  config.vm.provision 'docker' do |d|; end

  config.vm.provision 'shell', keep_color: true, privileged: false, name: 'shell:build ~> as vagrant', run: 'always', inline: <<-SHELL
    echo "Provisioner/shell:build"

    pushd /www/modules/run/dev; docker-compose build; popd
  SHELL

  config.vm.provision 'shell', keep_color: true, privileged: false, name: 'shell:start ~> as vagrant', run: 'always', inline: <<-SHELL
    echo "Provisioner/shell:start"

    pushd /www/modules/run/dev; docker-compose up; popd
  SHELL
end
